"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AreaCreationService = exports.AreaCreationModal = void 0;
const obsidian_1 = require("obsidian");
class AreaCreationModal extends obsidian_1.Modal {
    constructor(app, onSubmit) {
        super(app);
        this.result = { name: null };
        this.onSubmit = onSubmit;
    }
    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.createEl('h2', { text: 'Create New Child Area' });
        const inputContainer = contentEl.createDiv();
        inputContainer.style.marginBottom = '20px';
        const input = inputContainer.createEl('input', {
            type: 'text',
            placeholder: 'Enter area name...'
        });
        input.style.width = '100%';
        input.style.padding = '8px';
        input.style.fontSize = '14px';
        input.style.border = '1px solid var(--background-modifier-border)';
        input.style.borderRadius = '4px';
        input.style.background = 'var(--background-modifier-form-field)';
        input.style.color = 'var(--text-normal)';
        const buttonContainer = contentEl.createDiv();
        buttonContainer.style.display = 'flex';
        buttonContainer.style.gap = '10px';
        buttonContainer.style.justifyContent = 'flex-end';
        const cancelButton = buttonContainer.createEl('button', { text: 'Cancel' });
        cancelButton.style.padding = '8px 16px';
        cancelButton.style.border = '1px solid var(--background-modifier-border)';
        cancelButton.style.borderRadius = '4px';
        cancelButton.style.background = 'var(--background-secondary)';
        cancelButton.style.color = 'var(--text-normal)';
        cancelButton.style.cursor = 'pointer';
        const createButton = buttonContainer.createEl('button', { text: 'Create' });
        createButton.style.padding = '8px 16px';
        createButton.style.border = 'none';
        createButton.style.borderRadius = '4px';
        createButton.style.background = 'var(--interactive-accent)';
        createButton.style.color = 'var(--text-on-accent)';
        createButton.style.cursor = 'pointer';
        const submit = () => {
            const name = input.value.trim();
            this.result.name = name || null;
            this.close();
        };
        createButton.addEventListener('click', submit);
        cancelButton.addEventListener('click', () => {
            this.result.name = null;
            this.close();
        });
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                submit();
            }
            else if (e.key === 'Escape') {
                this.result.name = null;
                this.close();
            }
        });
        // Focus input
        setTimeout(() => input.focus(), 50);
    }
    onClose() {
        this.onSubmit(this.result);
    }
}
exports.AreaCreationModal = AreaCreationModal;
class AreaCreationService {
    constructor(app, settings) {
        this.app = app;
        this.settings = settings;
    }
    /**
     * Update settings reference
     */
    updateSettings(settings) {
        this.settings = settings;
    }
    /**
     * Create a new child area for the given parent area
     */
    async createChildArea(parentContext) {
        this.log('Creating child area for:', parentContext.fileName);
        try {
            const areaName = await this.showAreaNameModal();
            if (!areaName) {
                this.log('Area creation cancelled');
                return;
            }
            const creationData = this.prepareAreaCreationData(areaName, parentContext);
            const content = this.generateAreaContent(creationData);
            const filePath = this.generateAreaFilePath(areaName);
            await this.createAreaFile(filePath, content);
            await this.openNewArea(filePath);
            new obsidian_1.Notice(`Created new child area: ${areaName}`);
            this.log(`Successfully created child area: ${areaName} at ${filePath}`);
        }
        catch (error) {
            const errorMessage = `Failed to create area: ${error instanceof Error ? error.message : String(error)}`;
            console.error('[AreaCreationService]', errorMessage, error);
            new obsidian_1.Notice(errorMessage);
        }
    }
    /**
     * Show modal to get area name from user
     */
    showAreaNameModal() {
        return new Promise((resolve) => {
            new AreaCreationModal(this.app, (result) => {
                resolve(result.name);
            }).open();
        });
    }
    /**
     * Prepare area creation data
     */
    prepareAreaCreationData(name, parentContext) {
        return {
            name,
            parentPath: parentContext.fileName.replace('.md', ''),
            parentOntology: this.getParentOntology(parentContext),
            createdAt: this.getLocalTimestamp(),
            uid: this.generateUUID()
        };
    }
    /**
     * Generate area content with proper frontmatter
     */
    generateAreaContent(data) {
        return `---
exo__Asset_isDefinedBy: ${data.parentOntology}
exo__Asset_uid: ${data.uid}
exo__Asset_createdAt: ${data.createdAt}
exo__Instance_class:
  - "[[ems__Area]]"
ems__Area_parent: "[[${data.parentPath}]]"
---

# ${data.name}

`;
    }
    /**
     * Generate file path for the new area
     */
    generateAreaFilePath(name) {
        var _a;
        // Try to determine the appropriate folder based on current file location
        const activeFile = this.app.workspace.getActiveFile();
        if (activeFile) {
            const parentDir = ((_a = activeFile.parent) === null || _a === void 0 ? void 0 : _a.path) || '';
            if (parentDir) {
                return `${parentDir}/Area - ${name}.md`;
            }
        }
        // Fallback to default area folder
        return `03 Knowledge/Areas/Area - ${name}.md`;
    }
    /**
     * Create the area file
     */
    async createAreaFile(filePath, content) {
        // Ensure parent directories exist
        const parentPath = filePath.substring(0, filePath.lastIndexOf('/'));
        if (parentPath && !this.app.vault.getAbstractFileByPath(parentPath)) {
            await this.app.vault.createFolder(parentPath);
            this.log(`Created parent directory: ${parentPath}`);
        }
        return await this.app.vault.create(filePath, content);
    }
    /**
     * Open the newly created area in a new tab
     */
    async openNewArea(filePath) {
        const file = this.app.vault.getAbstractFileByPath(filePath);
        if (file instanceof obsidian_1.TFile) {
            const leaf = this.app.workspace.getLeaf('tab');
            await leaf.openFile(file);
            this.app.workspace.setActiveLeaf(leaf, { focus: true });
        }
    }
    /**
     * Generate UUID for the area
     */
    generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0;
            return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
    }
    /**
     * Get local timestamp without Z suffix
     */
    getLocalTimestamp() {
        const now = new Date();
        return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
    }
    /**
     * Get parent ontology from file context
     */
    getParentOntology(parentContext) {
        var _a;
        const parentOntology = parentContext.currentPage['exo__Asset_isDefinedBy'];
        if (typeof parentOntology === 'object' && parentOntology.path) {
            return `"[[${(_a = parentOntology.path.split('/').pop()) === null || _a === void 0 ? void 0 : _a.replace('.md', '')}]]"`;
        }
        if (typeof parentOntology === 'string') {
            return parentOntology;
        }
        // Default fallback
        return '"[[!ems]]"';
    }
    /**
     * Debug logging
     */
    log(message, ...args) {
        if (this.settings.enableDebugMode) {
            console.log(`[AreaCreationService] ${message}`, ...args);
        }
    }
}
exports.AreaCreationService = AreaCreationService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXJlYUNyZWF0aW9uU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy9BcmVhQ3JlYXRpb25TZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHVDQUFxRDtBQUlyRCxNQUFhLGlCQUFrQixTQUFRLGdCQUFLO0lBSTFDLFlBQVksR0FBUSxFQUFFLFFBQW1EO1FBQ3ZFLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUpMLFdBQU0sR0FBNEIsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFLdkQsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7SUFDM0IsQ0FBQztJQUVELE1BQU07UUFDSixNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQzNCLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUVsQixTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSx1QkFBdUIsRUFBRSxDQUFDLENBQUM7UUFFNUQsTUFBTSxjQUFjLEdBQUcsU0FBUyxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQzdDLGNBQWMsQ0FBQyxLQUFLLENBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQztRQUUzQyxNQUFNLEtBQUssR0FBRyxjQUFjLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRTtZQUM3QyxJQUFJLEVBQUUsTUFBTTtZQUNaLFdBQVcsRUFBRSxvQkFBb0I7U0FDbEMsQ0FBQyxDQUFDO1FBQ0gsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDO1FBQzNCLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUM1QixLQUFLLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUM7UUFDOUIsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsNkNBQTZDLENBQUM7UUFDbkUsS0FBSyxDQUFDLEtBQUssQ0FBQyxZ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LENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUEzS0Qsa0RBMktDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwLCBURmlsZSwgTm90aWNlLCBNb2RhbCB9IGZyb20gJ29ic2lkaWFuJztcbmltcG9ydCB7IEV4b0ZpbGVDb250ZXh0LCBBcmVhQ3JlYXRpb25EYXRhIH0gZnJvbSAnLi4vdHlwZXMvRXhvVHlwZXMnO1xuaW1wb3J0IHsgUHJpbnRUaXRsZVNldHRpbmdzIH0gZnJvbSAnLi4vdHlwZXMnO1xuXG5leHBvcnQgY2xhc3MgQXJlYUNyZWF0aW9uTW9kYWwgZXh0ZW5kcyBNb2RhbCB7XG4gIHByaXZhdGUgcmVzdWx0OiB7IG5hbWU6IHN0cmluZyB8IG51bGwgfSA9IHsgbmFtZTogbnVsbCB9O1xuICBwcml2YXRlIG9uU3VibWl0OiAocmVzdWx0OiB7IG5hbWU6IHN0cmluZyB8IG51bGwgfSkgPT4gdm9pZDtcblxuICBjb25zdHJ1Y3RvcihhcHA6IEFwcCwgb25TdWJtaXQ6IChyZXN1bHQ6IHsgbmFtZTogc3RyaW5nIHwgbnVsbCB9KSA9PiB2b2lkKSB7XG4gICAgc3VwZXIoYXBwKTtcbiAgICB0aGlzLm9uU3VibWl0ID0gb25TdWJtaXQ7XG4gIH1cblxuICBvbk9wZW4oKSB7XG4gICAgY29uc3QgeyBjb250ZW50RWwgfSA9IHRoaXM7XG4gICAgY29udGVudEVsLmVtcHR5KCk7XG5cbiAgICBjb250ZW50RWwuY3JlYXRlRWwoJ2gyJywgeyB0ZXh0OiAnQ3JlYXRlIE5ldyBDaGlsZCBBcmVhJyB9KTtcblxuICAgIGNvbnN0IGlucHV0Q29udGFpbmVyID0gY29udGVudEVsLmNyZWF0ZURpdigpO1xuICAgIGlucHV0Q29udGFpbmVyLnN0eWxlLm1hcmdpbkJvdHRvbSA9ICcyMHB4JztcblxuICAgIGNvbnN0IGlucHV0ID0gaW5wdXRDb250YWluZXIuY3JlYXRlRWwoJ2lucHV0Jywge1xuICAgICAgdHlwZTogJ3RleHQnLFxuICAgICAgcGxhY2Vob2xkZXI6ICdFbnRlciBhcmVhIG5hbWUuLi4nXG4gICAgfSk7XG4gICAgaW5wdXQuc3R5bGUud2lkdGggPSAnMTAwJSc7XG4gICAgaW5wdXQuc3R5bGUucGFkZGluZyA9ICc4cHgnO1xuICAgIGlucHV0LnN0eWxlLmZvbnRTaXplID0gJzE0cHgnO1xuICAgIGlucHV0LnN0eWxlLmJvcmRlciA9ICcxcHggc29saWQgdmFyKC0tYmFja2dyb3VuZC1tb2RpZmllci1ib3JkZXIpJztcbiAgICBpbnB1dC5zdHlsZS5ib3JkZXJSYWRpdXMgPSAnNHB4JztcbiAgICBpbnB1dC5zdHlsZS5iYWNrZ3JvdW5kID0gJ3ZhcigtLWJhY2tncm91bmQtbW9kaWZpZXItZm9ybS1maWVsZCknO1xuICAgIGlucHV0LnN0eWxlLmNvbG9yID0gJ3ZhcigtLXRleHQtbm9ybWFsKSc7XG5cbiAgICBjb25zdCBidXR0b25Db250YWluZXIgPSBjb250ZW50RWwuY3JlYXRlRGl2KCk7XG4gICAgYnV0dG9uQ29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7XG4gICAgYnV0dG9uQ29udGFpbmVyLnN0eWxlLmdhcCA9ICcxMHB4JztcbiAgICBidXR0b25Db250YWluZXIuc3R5bGUuanVzdGlmeUNvbnRlbnQgPSAnZmxleC1lbmQnO1xuXG4gICAgY29uc3QgY2FuY2VsQnV0dG9uID0gYnV0dG9uQ29udGFpbmVyLmNyZWF0ZUVsKCdidXR0b24nLCB7IHRleHQ6ICdDYW5jZWwnIH0pO1xuICAgIGNhbmNlbEJ1dHRvbi5zdHlsZS5wYWRkaW5nID0gJzhweCAxNnB4JztcbiAgICBjYW5jZWxCdXR0b24uc3R5bGUuYm9yZGVyID0gJzFweCBzb2xpZCB2YXIoLS1iYWNrZ3JvdW5kLW1vZGlmaWVyLWJvcmRlciknO1xuICAgIGNhbmNlbEJ1dHRvbi5zdHlsZS5ib3JkZXJSYWRpdXMgPSAnNHB4JztcbiAgICBjYW5jZWxCdXR0b24uc3R5bGUuYmFja2dyb3VuZCA9ICd2YXIoLS1iYWNrZ3JvdW5kLXNlY29uZGFyeSknO1xuICAgIGNhbmNlbEJ1dHRvbi5zdHlsZS5jb2xvciA9ICd2YXIoLS10ZXh0LW5vcm1hbCknO1xuICAgIGNhbmNlbEJ1dHRvbi5zdHlsZS5jdXJzb3IgPSAncG9pbnRlcic7XG5cbiAgICBjb25zdCBjcmVhdGVCdXR0b24gPSBidXR0b25Db250YWluZXIuY3JlYXRlRWwoJ2J1dHRvbicsIHsgdGV4dDogJ0NyZWF0ZScgfSk7XG4gICAgY3JlYXRlQnV0dG9uLnN0eWxlLnBhZGRpbmcgPSAnOHB4IDE2cHgnO1xuICAgIGNyZWF0ZUJ1dHRvbi5zdHlsZS5ib3JkZXIgPSAnbm9uZSc7XG4gICAgY3JlYXRlQnV0dG9uLnN0eWxlLmJvcmRlclJhZGl1cyA9ICc0cHgnO1xuICAgIGNyZWF0ZUJ1dHRvbi5zdHlsZS5iYWNrZ3JvdW5kID0gJ3ZhcigtLWludGVyYWN0aXZlLWFjY2VudCknO1xuICAgIGNyZWF0ZUJ1dHRvbi5zdHlsZS5jb2xvciA9ICd2YXIoLS10ZXh0LW9uLWFjY2VudCknO1xuICAgIGNyZWF0ZUJ1dHRvbi5zdHlsZS5jdXJzb3IgPSAncG9pbnRlcic7XG5cbiAgICBjb25zdCBzdWJtaXQgPSAoKSA9PiB7XG4gICAgICBjb25zdCBuYW1lID0gaW5wdXQudmFsdWUudHJpbSgpO1xuICAgICAgdGhpcy5yZXN1bHQubmFtZSA9IG5hbWUgfHwgbnVsbDtcbiAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICB9O1xuXG4gICAgY3JlYXRlQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgc3VibWl0KTtcbiAgICBjYW5jZWxCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICB0aGlzLnJlc3VsdC5uYW1lID0gbnVsbDtcbiAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICB9KTtcblxuICAgIGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4ge1xuICAgICAgaWYgKGUua2V5ID09PSAnRW50ZXInKSB7XG4gICAgICAgIHN1Ym1pdCgpO1xuICAgICAgfSBlbHNlIGlmIChlLmtleSA9PT0gJ0VzY2FwZScpIHtcbiAgICAgICAgdGhpcy5yZXN1bHQubmFtZSA9IG51bGw7XG4gICAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIEZvY3VzIGlucHV0XG4gICAgc2V0VGltZW91dCgoKSA9PiBpbnB1dC5mb2N1cygpLCA1MCk7XG4gIH1cblxuICBvbkNsb3NlKCkge1xuICAgIHRoaXMub25TdWJtaXQodGhpcy5yZXN1bHQpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBBcmVhQ3JlYXRpb25TZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhcHA6IEFwcCxcbiAgICBwcml2YXRlIHNldHRpbmdzOiBQcmludFRpdGxlU2V0dGluZ3NcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgc2V0dGluZ3MgcmVmZXJlbmNlXG4gICAqL1xuICB1cGRhdGVTZXR0aW5ncyhzZXR0aW5nczogUHJpbnRUaXRsZVNldHRpbmdzKTogdm9pZCB7XG4gICAgdGhpcy5zZXR0aW5ncyA9IHNldHRpbmdzO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIG5ldyBjaGlsZCBhcmVhIGZvciB0aGUgZ2l2ZW4gcGFyZW50IGFyZWFcbiAgICovXG4gIGFzeW5jIGNyZWF0ZUNoaWxkQXJlYShwYXJlbnRDb250ZXh0OiBFeG9GaWxlQ29udGV4dCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMubG9nKCdDcmVhdGluZyBjaGlsZCBhcmVhIGZvcjonLCBwYXJlbnRDb250ZXh0LmZpbGVOYW1lKTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBhcmVhTmFtZSA9IGF3YWl0IHRoaXMuc2hvd0FyZWFOYW1lTW9kYWwoKTtcbiAgICAgIGlmICghYXJlYU5hbWUpIHtcbiAgICAgICAgdGhpcy5sb2coJ0FyZWEgY3JlYXRpb24gY2FuY2VsbGVkJyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgY3JlYXRpb25EYXRhID0gdGhpcy5wcmVwYXJlQXJlYUNyZWF0aW9uRGF0YShhcmVhTmFtZSwgcGFyZW50Q29udGV4dCk7XG4gICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5nZW5lcmF0ZUFyZWFDb250ZW50KGNyZWF0aW9uRGF0YSk7XG4gICAgICBjb25zdCBmaWxlUGF0aCA9IHRoaXMuZ2VuZXJhdGVBcmVhRmlsZVBhdGgoYXJlYU5hbWUpO1xuXG4gICAgICBhd2FpdCB0aGlzLmNyZWF0ZUFyZWFGaWxlKGZpbGVQYXRoLCBjb250ZW50KTtcbiAgICAgIGF3YWl0IHRoaXMub3Blbk5ld0FyZWEoZmlsZVBhdGgpO1xuXG4gICAgICBuZXcgTm90aWNlKGBDcmVhdGVkIG5ldyBjaGlsZCBhcmVhOiAke2FyZWFOYW1lfWApO1xuICAgICAgdGhpcy5sb2coYFN1Y2Nlc3NmdWxseSBjcmVhdGVkIGNoaWxkIGFyZWE6ICR7YXJlYU5hbWV9IGF0ICR7ZmlsZVBhdGh9YCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGBGYWlsZWQgdG8gY3JlYXRlIGFyZWE6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWA7XG4gICAgICBjb25zb2xlLmVycm9yKCdbQXJlYUNyZWF0aW9uU2VydmljZV0nLCBlcnJvck1lc3NhZ2UsIGVycm9yKTtcbiAgICAgIG5ldyBOb3RpY2UoZXJyb3JNZXNzYWdlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2hvdyBtb2RhbCB0byBnZXQgYXJlYSBuYW1lIGZyb20gdXNlclxuICAgKi9cbiAgcHJpdmF0ZSBzaG93QXJlYU5hbWVNb2RhbCgpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIG5ldyBBcmVhQ3JlYXRpb25Nb2RhbCh0aGlzLmFwcCwgKHJlc3VsdCkgPT4ge1xuICAgICAgICByZXNvbHZlKHJlc3VsdC5uYW1lKTtcbiAgICAgIH0pLm9wZW4oKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcmVwYXJlIGFyZWEgY3JlYXRpb24gZGF0YVxuICAgKi9cbiAgcHJpdmF0ZSBwcmVwYXJlQXJlYUNyZWF0aW9uRGF0YShuYW1lOiBzdHJpbmcsIHBhcmVudENvbnRleHQ6IEV4b0ZpbGVDb250ZXh0KTogQXJlYUNyZWF0aW9uRGF0YSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICBwYXJlbnRQYXRoOiBwYXJlbnRDb250ZXh0LmZpbGVOYW1lLnJlcGxhY2UoJy5tZCcsICcnKSxcbiAgICAgIHBhcmVudE9udG9sb2d5OiB0aGlzLmdldFBhcmVudE9udG9sb2d5KHBhcmVudENvbnRleHQpLFxuICAgICAgY3JlYXRlZEF0OiB0aGlzLmdldExvY2FsVGltZXN0YW1wKCksXG4gICAgICB1aWQ6IHRoaXMuZ2VuZXJhdGVVVUlEKClcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIGFyZWEgY29udGVudCB3aXRoIHByb3BlciBmcm9udG1hdHRlclxuICAgKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZUFyZWFDb250ZW50KGRhdGE6IEFyZWFDcmVhdGlvbkRhdGEpOiBzdHJpbmcge1xuICAgIHJldHVybiBgLS0tXG5leG9fX0Fzc2V0X2lzRGVmaW5lZEJ5OiAke2RhdGEucGFyZW50T250b2xvZ3l9XG5leG9fX0Fzc2V0X3VpZDogJHtkYXRhLnVpZH1cbmV4b19fQXNzZXRfY3JlYXRlZEF0OiAke2RhdGEuY3JlYXRlZEF0fVxuZXhvX19JbnN0YW5jZV9jbGFzczpcbiAgLSBcIltbZW1zX19BcmVhXV1cIlxuZW1zX19BcmVhX3BhcmVudDogXCJbWyR7ZGF0YS5wYXJlbnRQYXRofV1dXCJcbi0tLVxuXG4jICR7ZGF0YS5uYW1lfVxuXG5gO1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIGZpbGUgcGF0aCBmb3IgdGhlIG5ldyBhcmVhXG4gICAqL1xuICBwcml2YXRlIGdlbmVyYXRlQXJlYUZpbGVQYXRoKG5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgLy8gVHJ5IHRvIGRldGVybWluZSB0aGUgYXBwcm9wcmlhdGUgZm9sZGVyIGJhc2VkIG9uIGN1cnJlbnQgZmlsZSBsb2NhdGlvblxuICAgIGNvbnN0IGFjdGl2ZUZpbGUgPSB0aGlzLmFwcC53b3Jrc3BhY2UuZ2V0QWN0aXZlRmlsZSgpO1xuICAgIGlmIChhY3RpdmVGaWxlKSB7XG4gICAgICBjb25zdCBwYXJlbnREaXIgPSBhY3RpdmVGaWxlLnBhcmVudD8ucGF0aCB8fCAnJztcbiAgICAgIGlmIChwYXJlbnREaXIpIHtcbiAgICAgICAgcmV0dXJuIGAke3BhcmVudERpcn0vQXJlYSAtICR7bmFtZX0ubWRgO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvLyBGYWxsYmFjayB0byBkZWZhdWx0IGFyZWEgZm9sZGVyXG4gICAgcmV0dXJuIGAwMyBLbm93bGVkZ2UvQXJlYXMvQXJlYSAtICR7bmFtZX0ubWRgO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSB0aGUgYXJlYSBmaWxlXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGNyZWF0ZUFyZWFGaWxlKGZpbGVQYXRoOiBzdHJpbmcsIGNvbnRlbnQ6IHN0cmluZyk6IFByb21pc2U8VEZpbGU+IHtcbiAgICAvLyBFbnN1cmUgcGFyZW50IGRpcmVjdG9yaWVzIGV4aXN0XG4gICAgY29uc3QgcGFyZW50UGF0aCA9IGZpbGVQYXRoLnN1YnN0cmluZygwLCBmaWxlUGF0aC5sYXN0SW5kZXhPZignLycpKTtcbiAgICBpZiAocGFyZW50UGF0aCAmJiAhdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKHBhcmVudFBhdGgpKSB7XG4gICAgICBhd2FpdCB0aGlzLmFwcC52YXVsdC5jcmVhdGVGb2xkZXIocGFyZW50UGF0aCk7XG4gICAgICB0aGlzLmxvZyhgQ3JlYXRlZCBwYXJlbnQgZGlyZWN0b3J5OiAke3BhcmVudFBhdGh9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuYXBwLnZhdWx0LmNyZWF0ZShmaWxlUGF0aCwgY29udGVudCk7XG4gIH1cblxuICAvKipcbiAgICogT3BlbiB0aGUgbmV3bHkgY3JlYXRlZCBhcmVhIGluIGEgbmV3IHRhYlxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBvcGVuTmV3QXJlYShmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChmaWxlUGF0aCk7XG4gICAgaWYgKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkge1xuICAgICAgY29uc3QgbGVhZiA9IHRoaXMuYXBwLndvcmtzcGFjZS5nZXRMZWFmKCd0YWInKTtcbiAgICAgIGF3YWl0IGxlYWYub3BlbkZpbGUoZmlsZSk7XG4gICAgICB0aGlzLmFwcC53b3Jrc3BhY2Uuc2V0QWN0aXZlTGVhZihsZWFmLCB7IGZvY3VzOiB0cnVlIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBVVUlEIGZvciB0aGUgYXJlYVxuICAgKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZVVVSUQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gJ3h4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3h5XS9nLCBjID0+IHtcbiAgICAgIGNvbnN0IHIgPSBNYXRoLnJhbmRvbSgpICogMTYgfCAwO1xuICAgICAgcmV0dXJuIChjID09PSAneCcgPyByIDogKHIgJiAweDMgfCAweDgpKS50b1N0cmluZygxNik7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGxvY2FsIHRpbWVzdGFtcCB3aXRob3V0IFogc3VmZml4XG4gICAqL1xuICBwcml2YXRlIGdldExvY2FsVGltZXN0YW1wKCk6IHN0cmluZyB7XG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICByZXR1cm4gYCR7bm93LmdldEZ1bGxZZWFyKCl9LSR7U3RyaW5nKG5vdy5nZXRNb250aCgpICsgMSkucGFkU3RhcnQoMiwgJzAnKX0tJHtTdHJpbmcobm93LmdldERhdGUoKSkucGFkU3RhcnQoMiwgJzAnKX1UJHtTdHJpbmcobm93LmdldEhvdXJzKCkpLnBhZFN0YXJ0KDIsICcwJyl9OiR7U3RyaW5nKG5vdy5nZXRNaW51dGVzKCkpLnBhZFN0YXJ0KDIsICcwJyl9OiR7U3RyaW5nKG5vdy5nZXRTZWNvbmRzKCkpLnBhZFN0YXJ0KDIsICcwJyl9YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgcGFyZW50IG9udG9sb2d5IGZyb20gZmlsZSBjb250ZXh0XG4gICAqL1xuICBwcml2YXRlIGdldFBhcmVudE9udG9sb2d5KHBhcmVudENvbnRleHQ6IEV4b0ZpbGVDb250ZXh0KTogc3RyaW5nIHtcbiAgICBjb25zdCBwYXJlbnRPbnRvbG9neSA9IHBhcmVudENvbnRleHQuY3VycmVudFBhZ2VbJ2V4b19fQXNzZXRfaXNEZWZpbmVkQnknXTtcbiAgICBcbiAgICBpZiAodHlwZW9mIHBhcmVudE9udG9sb2d5ID09PSAnb2JqZWN0JyAmJiBwYXJlbnRPbnRvbG9neS5wYXRoKSB7XG4gICAgICByZXR1cm4gYFwiW1ske3BhcmVudE9udG9sb2d5LnBhdGguc3BsaXQoJy8nKS5wb3AoKT8ucmVwbGFjZSgnLm1kJywgJycpfV1dXCJgO1xuICAgIH1cbiAgICBcbiAgICBpZiAodHlwZW9mIHBhcmVudE9udG9sb2d5ID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIHBhcmVudE9udG9sb2d5O1xuICAgIH1cbiAgICBcbiAgICAvLyBEZWZhdWx0IGZhbGxiYWNrXG4gICAgcmV0dXJuICdcIltbIWVtc11dXCInO1xuICB9XG5cbiAgLyoqXG4gICAqIERlYnVnIGxvZ2dpbmdcbiAgICovXG4gIHByaXZhdGUgbG9nKG1lc3NhZ2U6IHN0cmluZywgLi4uYXJnczogYW55W10pOiB2b2lkIHtcbiAgICBpZiAodGhpcy5zZXR0aW5ncy5lbmFibGVEZWJ1Z01vZGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKGBbQXJlYUNyZWF0aW9uU2VydmljZV0gJHttZXNzYWdlfWAsIC4uLmFyZ3MpO1xuICAgIH1cbiAgfVxufSJdfQ==